<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - SI Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { 
            font-family: 'Inter', sans-serif; 
        } 
    </style>
</head>
<body class="bg-gray-200">

    <div class="flex h-screen bg-gray-200">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white p-5 flex flex-col">
            <h1 class="text-2xl font-bold mb-10">Admin SI Delivery</h1>
            <nav>
                <a href="#orders" class="block py-2.5 px-4 rounded hover:bg-gray-700">Pedidos</a>
                <a href="#products" class="block py-2.5 px-4 rounded hover:bg-gray-700">Produtos</a>
                <a href="#coupons" class="block py-2.5 px-4 rounded hover:bg-gray-700">Cupons</a>
            </nav>
            <div id="auth-info-admin" class="text-xs text-gray-400 mt-auto">Carregando...</div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                
                <!-- Seção de Pedidos -->
                <section id="orders">
                    <h2 class="text-2xl font-semibold mb-4">Pedidos Recebidos</h2>
                    <div id="orders-list" class="space-y-4">
                        <p class="text-gray-500">Carregando pedidos...</p>
                    </div>
                </section>

                <hr class="my-8">

                <!-- Seção de Produtos -->
                <section id="products">
                    <h2 class="text-2xl font-semibold mb-4">Gerenciar Produtos</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 id="form-title" class="text-xl font-bold mb-4">Adicionar Novo Produto</h3>
                        <form id="product-form" class="space-y-4">
                            <input type="hidden" id="product-id">
                            <input type="text" id="product-name" placeholder="Nome do Produto" class="w-full p-2 border rounded" required>
                            <input type="number" id="product-price" placeholder="Preço (ex: 5.50)" step="0.01" class="w-full p-2 border rounded" required>
                            <select id="product-category" class="w-full p-2 border rounded" required>
                                <option value="">Selecione a Categoria</option>
                                <option value="Cervejas">Cervejas</option>
                                <option value="Destilados">Destilados</option>
                                <option value="Vinhos">Vinhos</option>
                                <option value="Não Alcoólicos">Não Alcoólicos</option>
                                <option value="Complementos">Complementos</option>
                            </select>
                            <input type="text" id="product-image-url" placeholder="URL da Imagem" class="w-full p-2 border rounded">
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Salvar Produto</button>
                                <button type="button" id="cancel-edit-btn" class="w-full bg-gray-300 py-2 rounded hover:bg-gray-400 hidden">Cancelar Edição</button>
                            </div>
                        </form>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Produtos Cadastrados</h3>
                        <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <p class="text-gray-500">Carregando produtos...</p>
                        </div>
                    </div>
                </section>

                <hr class="my-8">

                <!-- Seção de Cupons -->
                <section id="coupons">
                    <h2 class="text-2xl font-semibold mb-4">Gerenciar Cupons</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 id="coupon-form-title" class="text-xl font-bold mb-4">Criar Novo Cupom</h3>
                        <form id="coupon-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <input type="text" id="coupon-code-admin" placeholder="Código (ex: BEMVINDO10)" class="p-2 border rounded uppercase" required>
                            <select id="coupon-type-admin" class="p-2 border rounded" required>
                                <option value="percentage">Porcentagem (%)</option>
                                <option value="fixed">Valor Fixo (R$)</option>
                            </select>
                            <input type="number" id="coupon-value-admin" placeholder="Valor" step="0.01" class="w-full p-2 border rounded" required>
                            <button type="submit" class="md:col-span-3 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Salvar Cupom</button>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Cupons Ativos</h3>
                        <div id="coupons-list" class="space-y-2">
                             <p class="text-gray-500">Carregando cupons...</p>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAk3MgbFZJjoK3JPU6t0yWILa0DzynaKzY",
          authDomain: "sidelivery-19c9f.firebaseapp.com",
          projectId: "sidelivery-19c9f",
          storageBucket: "sidelivery-19c9f.appspot.com",
          messagingSenderId: "824305265358",
          appId: "1:824305265358:web:912c24aae00034fd003e9f",
          measurementId: "G-GF93Z3H2CT"
        };
        
        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const productsCollection = collection(db, "products");
        const ordersCollection = collection(db, "orders");
        const couponsCollection = collection(db, "coupons");

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-info-admin').textContent = `Admin Conectado`;
                await addSampleProductsIfNeeded();
                listenToOrders();
                listenToProducts();
                listenToCoupons();
            } else {
                document.getElementById('auth-info-admin').textContent = `Admin não conectado.`;
                document.getElementById('orders-list').innerHTML = '<p class="text-red-500 font-semibold">Você precisa estar autenticado para ver os dados.</p>';
                document.getElementById('products-list').innerHTML = '<p class="text-red-500 font-semibold">Você precisa estar autenticado para ver os dados.</p>';
                document.getElementById('coupons-list').innerHTML = '<p class="text-red-500 font-semibold">Você precisa estar autenticado para ver os dados.</p>';
            }
        });

        async function addSampleProductsIfNeeded() {
            const q = query(productsCollection);
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                const sampleProducts = [
                    { name: 'Cerveja Brahma 350ml', price: 3.50, category: 'Cervejas', imageUrl: 'https://placehold.co/100x100/F44336/FFFFFF?text=Brahma' },
                    { name: 'Cerveja Skol 350ml', price: 3.50, category: 'Cervejas', imageUrl: 'https://placehold.co/100x100/FFC107/FFFFFF?text=Skol' },
                    { name: 'Cerveja Heineken 330ml', price: 5.50, category: 'Cervejas', imageUrl: 'https://placehold.co/100x100/4CAF50/FFFFFF?text=Heineken' },
                    { name: 'Gin Tanqueray 750ml', price: 99.90, category: 'Destilados', imageUrl: 'https://placehold.co/100x100/009688/FFFFFF?text=Gin' },
                    { name: 'Vodka Absolut 750ml', price: 89.90, category: 'Destilados', imageUrl: 'https://placehold.co/100x100/03A9F4/FFFFFF?text=Vodka' },
                    { name: 'Whisky Red Label 750ml', price: 85.00, category: 'Destilados', imageUrl: 'https://placehold.co/100x100/E53935/FFFFFF?text=Whisky' },
                    { name: 'Vinho Casillero del Diablo 750ml', price: 55.00, category: 'Vinhos', imageUrl: 'https://placehold.co/100x100/880E4F/FFFFFF?text=Vinho' },
                    { name: 'Coca-Cola 2L', price: 9.00, category: 'Não Alcoólicos', imageUrl: 'https://placehold.co/100x100/f44336/FFFFFF?text=Coca' },
                    { name: 'Guaraná Antarctica 2L', price: 8.50, category: 'Não Alcoólicos', imageUrl: 'https://placehold.co/100x100/4CAF50/FFFFFF?text=Guaraná' },
                    { name: 'Água Mineral 500ml', price: 2.50, category: 'Não Alcoólicos', imageUrl: 'https://placehold.co/100x100/2196F3/FFFFFF?text=Água' },
                    { name: 'Gelo em Cubo 5kg', price: 10.00, category: 'Complementos', imageUrl: 'https://placehold.co/100x100/E0F7FA/000000?text=Gelo' },
                    { name: 'Carvão 3kg', price: 15.00, category: 'Complementos', imageUrl: 'https://placehold.co/100x100/616161/FFFFFF?text=Carvão' },
                ];
                for (const product of sampleProducts) {
                    await addDoc(productsCollection, product);
                }
            }
        }

        // --- GERENCIAMENTO DE PEDIDOS ---
        function listenToOrders() {
            const q = query(ordersCollection);
            onSnapshot(q, (snapshot) => {
                const ordersList = document.getElementById('orders-list');
                if (snapshot.empty) {
                    ordersList.innerHTML = '<p class="text-gray-500">Nenhum pedido recebido ainda.</p>';
                    return;
                }
                let orders = [];
                snapshot.forEach(doc => orders.push({ id: doc.id, ...doc.data() }));
                orders.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                ordersList.innerHTML = orders.map(order => `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${order.customerName}</p>
                                <p class="text-sm text-gray-600">${order.customerAddress}</p>
                                <p class="text-sm text-gray-500">${order.createdAt.toDate().toLocaleString('pt-BR')}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
                                <p class="text-sm">Pagamento: ${order.paymentMethod === 'stripe' ? 'Online' : 'Na Entrega'}</p>
                            </div>
                        </div>
                         <div class="mt-2">
                            <ul class="list-disc list-inside text-sm">
                                ${order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('')}
                            </ul>
                        </div>
                        ${order.instructions ? `<div class="mt-2 p-2 bg-yellow-100 rounded-md text-sm"><strong>Instruções:</strong> ${order.instructions}</div>` : ''}
                        ${order.coupon ? `<div class="mt-2 text-sm text-green-600"><strong>Cupom Usado:</strong> ${order.coupon.code} (-R$ ${order.coupon.discount.toFixed(2).replace('.',',')})</div>` : ''}
                        <div class="mt-4 flex items-center justify-between">
                            <p class="text-sm font-semibold">Status:</p>
                            <select onchange="updateOrderStatus('${order.id}', this.value)" class="p-2 border rounded">
                                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                <option value="in_preparation" ${order.status === 'in_preparation' ? 'selected' : ''}>Em Preparo</option>
                                <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Saiu para Entrega</option>
                                <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Concluído</option>
                                <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </div>
                    </div>
                `).join('');
            });
        }

        window.updateOrderStatus = async (orderId, newStatus) => {
            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating order status: ", error);
            }
        };

        // --- GERENCIAMENTO DE PRODUTOS (CRUD) ---
        const productForm = document.getElementById('product-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                imageUrl: document.getElementById('product-image-url').value,
            };

            try {
                if (id) {
                    const productRef = doc(db, "products", id);
                    await updateDoc(productRef, productData);
                } else {
                    await addDoc(productsCollection, productData);
                }
                resetForm();
            } catch (error) {
                console.error("Error saving product: ", error);
            }
        });

        cancelEditBtn.addEventListener('click', resetForm);

        function resetForm() {
            productForm.reset();
            document.getElementById('product-id').value = '';
            document.getElementById('form-title').textContent = 'Adicionar Novo Produto';
            cancelEditBtn.classList.add('hidden');
        }

        function listenToProducts() {
            onSnapshot(productsCollection, (snapshot) => {
                const productsList = document.getElementById('products-list');
                if (snapshot.empty) {
                    productsList.innerHTML = '<p class="text-gray-500">Nenhum produto cadastrado.</p>';
                    return;
                }
                productsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col';
                    card.innerHTML = `
                        <img src="${product.imageUrl || 'https://placehold.co/300x200/CCCCCC/FFFFFF?text=Sem+Imagem'}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-4">
                        <h4 class="font-bold flex-1">${product.name}</h4>
                        <p class="text-gray-600">${product.category}</p>
                        <p class="text-green-600 font-semibold text-lg">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                        <div class="mt-4 flex space-x-2">
                            <button class="edit-btn w-full bg-yellow-400 text-sm py-1 rounded hover:bg-yellow-500">Editar</button>
                            <button class="delete-btn w-full bg-red-500 text-white text-sm py-1 rounded hover:bg-red-600">Excluir</button>
                        </div>
                    `;
                    card.querySelector('.edit-btn').addEventListener('click', () => editProduct(product));
                    card.querySelector('.delete-btn').addEventListener('click', () => deleteProduct(product.id, product.name));
                    productsList.appendChild(card);
                });
            });
        }

        function editProduct(product) {
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-image-url').value = product.imageUrl;
            document.getElementById('form-title').textContent = 'Editando Produto';
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('products').offsetTop, behavior: 'smooth' });
        }

        async function deleteProduct(id, name) {
            if (confirm(`Tem certeza que deseja excluir o produto "${name}"?`)) {
                try {
                    const productRef = doc(db, "products", id);
                    await deleteDoc(productRef);
                } catch (error) {
                    console.error("Error deleting product: ", error);
                }
            }
        }

        // --- GERENCIAMENTO DE CUPONS ---
        document.getElementById('coupon-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('coupon-code-admin').value.trim().toUpperCase();
            const couponData = {
                type: document.getElementById('coupon-type-admin').value,
                value: parseFloat(document.getElementById('coupon-value-admin').value),
                active: true
            };
            if (!code || !couponData.value) return;
            
            const couponRef = doc(db, "coupons", code);
            await setDoc(couponRef, couponData);
            document.getElementById('coupon-form').reset();
        });

        function listenToCoupons() {
            onSnapshot(query(couponsCollection), (snapshot) => {
                const listEl = document.getElementById('coupons-list');
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500">Nenhum cupom criado.</p>';
                    return;
                }
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const coupon = { id: doc.id, ...doc.data() };
                    const couponCard = document.createElement('div');
                    couponCard.className = 'bg-white p-3 rounded-md shadow-sm flex justify-between items-center';
                    couponCard.innerHTML = `
                        <div>
                            <span class="font-mono bg-gray-200 px-2 py-1 rounded">${coupon.id}</span>
                            <span class="ml-4">${coupon.type === 'fixed' ? `R$ ${coupon.value.toFixed(2).replace('.',',')}` : `${coupon.value}%`} de desconto</span>
                        </div>
                        <button class="delete-coupon-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    `;
                    couponCard.querySelector('.delete-coupon-btn').addEventListener('click', () => deleteCoupon(coupon.id));
                    listEl.appendChild(couponCard);
                });
            });
        }

        async function deleteCoupon(id) {
            if (confirm(`Tem certeza que deseja excluir o cupom "${id}"?`)) {
                const couponRef = doc(db, "coupons", id);
                await deleteDoc(couponRef);
            }
        }
    </script>
</body>
</html>
